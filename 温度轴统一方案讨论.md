# 温度轴统一方案讨论

## 一、目标

### 统一后的温度轴
```
[-55, -40, 25, 50, 75, 100, 125, 150, 170]  (共9个温度点，单位：°C)
```

### 需要处理的数据类型

1. **turn_on_loss（开通损耗）**
   - 数据结构：`energy.data` - 三维数组 `[温度][电压][电流]`
   - 温度轴：`temperature_axis`
   - 其他轴：`voltage_axis`, `current_axis`

2. **turn_off_loss（关断损耗）**
   - 数据结构：`energy.data` - 三维数组 `[温度][电压][电流]`
   - 温度轴：`temperature_axis`
   - 其他轴：`voltage_axis`, `current_axis`

3. **conduction_loss（导通损耗）**
   - 数据结构：`voltage_drop.data` - 二维数组 `[温度][电流]`
   - 温度轴：`temperature_axis`
   - 其他轴：`current_axis`
   - 注意：可能有多个conduction_loss条目（如gate="on"和gate="off"）

---

## 二、需要处理的情况分类

### 情况1：需要移除的温度点
- **900°C** 和 **1000°C** - 需要从所有数据中移除 -->没必要移除，之后数据处理不用它就好了。

### 情况2：需要插值的温度点
- **-55°C** - 如果原数据没有，需要从更低温度外推或从更高温度插值
- **-40°C** - 如果原数据没有，需要插值
- **50°C** - 如果原数据没有，需要插值
- **75°C** - 如果原数据没有，需要插值
- **100°C** - 如果原数据没有，需要插值
- **125°C** - 如果原数据没有，需要插值
- **150°C** - 如果原数据没有，需要插值
- **170°C** - 如果原数据没有，需要从更高温度外推 -->175度

### 情况3：需要保留的温度点
- **25°C** - 标准室温，几乎所有数据都有

---

## 三、插值方案讨论

### 方案A：线性插值（Linear Interpolation）
**优点：**
- 简单快速
- 对于温度特性变化较平滑的数据效果好
- 实现简单

**缺点：**
- 对于非线性特性可能不够准确
- 外推时误差可能较大

**适用场景：**
- 温度点之间距离较近（如50°C在25°C和75°C之间）
- 数据变化相对平滑

### 方案B：样条插值（Spline Interpolation）
**优点：**
- 更平滑的插值曲线
- 对非线性特性拟合更好

**缺点：**
- 计算复杂度较高
- 需要足够的数据点
- 外推时可能不稳定

**适用场景：**
- 数据点较多且分布均匀
- 需要平滑的插值结果

### 方案C：分段线性插值 + 外推策略
**优点：**
- 简单实用
- 可以针对不同温度范围采用不同策略

**策略：**
- **内插**（温度在数据范围内）：使用线性插值
- **外推**（温度超出数据范围）：
  - 低温外推（<-55°C）：使用最近两个温度点的线性外推
  - 高温外推（>170°C）：使用最近两个温度点的线性外推，但需要限制增长率

**适用场景：**
- 推荐使用，平衡了准确性和简单性

---

## 四、具体实现策略

### 步骤1：数据预处理
1. 遍历所有JSON文件
2. 识别每个文件中的温度轴
3. 分类处理：
   - 移除900°C和1000°C的数据
   - 识别缺失的目标温度点
   - 识别需要外推的温度点

### 步骤2：插值处理

#### 对于三维数据（Energy数据 - turn_on_loss, turn_off_loss）
```
对于每个 [电压][电流] 组合：
  1. 提取该组合在所有温度下的值
  2. 对缺失温度点进行插值
  3. 更新数据数组
```

#### 对于二维数据（VoltageDrop数据 - conduction_loss）
```
对于每个 [电流] 值：
  1. 提取该电流在所有温度下的值
  2. 对缺失温度点进行插值
  3. 更新数据数组
```

### 步骤3：温度轴更新
- 统一更新所有 `temperature_axis` 为目标温度轴
- 确保数据数组的维度与温度轴一致

---

## 五、边界情况处理

### 情况1：数据点不足
**问题：** 某些文件可能只有1-2个温度点（如C3D03060E.json只有25°C）

**处理方案：**
- **选项A**：使用常数外推（所有温度使用相同值）
- **选项B**：使用物理模型估算（如果有公式）
- **选项C**：标记为"数据不足"，保留原数据或使用默认值

**建议：** 选项A（常数外推）+ 在metadata中标记数据质量

### 情况2：温度范围不覆盖目标范围
**问题：** 原数据最高温度只有150°C，需要外推到170°C

**处理方案：**
- 使用最近两个温度点的线性外推
- 设置增长率上限（避免不合理的值）
- 在metadata中标记为"外推数据"

### 情况3：温度点顺序不一致
**问题：** 某些文件的温度轴可能不是升序排列

**处理方案：**
- 先对温度轴排序
- 同时调整数据数组的顺序

---

## 六、数据质量标记

建议在metadata中添加字段：
```json
"data_quality": {
  "temperature_interpolation": true,
  "interpolated_temperatures": [-40, 50, 100, 150, 170],
  "extrapolated_temperatures": [170],
  "original_temperature_range": [25, 125, 900, 1000]
}
```

---

## 七、实现建议

### 推荐方案：**分段线性插值 + 外推策略**

**理由：**
1. 简单可靠，易于验证
2. 对于功率器件，温度特性通常在正常工作范围内相对线性
3. 外推时可以使用保守策略（限制增长率）

### 实现步骤：
1. **数据收集阶段**：统计所有文件的温度轴分布
2. **插值函数**：实现线性插值函数（支持内插和外推）
3. **批量处理**：遍历所有文件，统一处理
4. **验证阶段**：抽样检查插值结果的合理性
5. **备份原数据**：处理前备份，便于回滚

### 插值函数伪代码：
```python
def interpolate_temperature(data_dict, target_temps, original_temps, original_data):
    """
    data_dict: 包含所有轴信息的字典
    target_temps: 目标温度轴 [-55, -40, 25, 50, 75, 100, 125, 150, 170]
    original_temps: 原始温度轴
    original_data: 原始数据数组
    """
    result_data = []
    
    for target_temp in target_temps:
        if target_temp in original_temps:
            # 直接使用原数据
            idx = original_temps.index(target_temp)
            result_data.append(original_data[idx])
        else:
            # 需要插值或外推
            if target_temp < min(original_temps):
                # 低温外推
                value = extrapolate_low(temp, original_temps, original_data)
            elif target_temp > max(original_temps):
                # 高温外推
                value = extrapolate_high(temp, original_temps, original_data)
            else:
                # 内插
                value = linear_interpolate(temp, original_temps, original_data)
            result_data.append(value)
    
    return result_data
```

---

## 八、需要讨论的问题

1. **插值方法选择**：线性插值 vs 样条插值？
2. **外推策略**：如何限制外推时的增长率？
3. **数据不足处理**：只有1-2个温度点的文件如何处理？
4. **验证方法**：如何验证插值结果的合理性？
5. **备份策略**：是否需要保留原始数据？
6. **处理范围**：是否只处理有900/1000度的文件，还是所有文件都统一？

---

## 九、风险评估

### 风险1：插值误差
- **影响**：可能导致仿真结果不准确
- **缓解**：使用保守的插值策略，在metadata中标记

### 风险2：外推不准确
- **影响**：170°C的外推值可能不准确
- **缓解**：使用最近两个温度点的线性外推，设置增长率上限

### 风险3：数据不一致
- **影响**：不同文件的插值结果可能不一致
- **缓解**：使用统一的插值算法和参数

---

## 十、下一步行动

1. **确认插值方案**：讨论并确定最终方案
2. **实现插值函数**：编写并测试插值算法
3. **批量处理脚本**：编写处理所有文件的脚本
4. **验证和测试**：抽样验证处理结果
5. **文档更新**：更新数据特征总结文档

